package eth1

import (
	"encoding/hex"
	"encoding/json"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/stretchr/testify/require"
	"go.uber.org/zap"
	"strings"
	"testing"
)

func TestParseOperatorAddedEvent(t *testing.T) {
	rawOperatorAdded := `{
   "address":"0xfdff361ed2b094730fdd8fa9658b370ce6cd4b10",
   "topics":[
      "0x39b34f12d0a1eb39d220d2acd5e293c894753a36ac66da43b832c9f1fdb8254e",
      "0x000000000000000000000000a7a7720499b7eb1f1408a8a319284bfd2db4a427"
   ],
   "data":"0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000007617364313132330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642646c566d556a684954326c73643364695a6d56344f45707559564d4b623068535655565164585a35615442345954564c52466454575455345632746d557a4a324e6a644a56444d795232526863555176616b746e5131704d624849354e6d6461636d49306247394b615535555348686f62677046633031784d4531365331466b5a56525953584a48644555305747644751546b31557a42726447354657446c69636c497a4e4652454d6b6c4753544a45615467354f465633613270524e306469626a5a735645646e436b686f61324e69626a5654536d644252533876523152444d6c524b62697378626b6458516b64524e6a68355356687057575a4f534846495430707a6347704a546d704a516c563651304e535a336c4c5648704b4e47734b61486c74553370714f555270566c684b636a4a4b555646755430567556564a4c4f47787a543364706155564455456855533278506545526f645446355a6c4d335a565a4d656d566c565773725a45564a556d31504b776f79634539315345706b57575a496230566a61533932637a6459656e677661336430524856484e46705262464a4b5a6b68315a556c6e4d454a76553046324f544e536444684c5347315152586c3661464653526d4e54436d78335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b00000000000000000000000000000000000000000000000000000000",
   "blockNumber":"0x5aa931",
   "transactionHash":"0x11faa7b8d54ef0cfbc299e174344a826a6912198a202f10df020933198252e27",
   "transactionIndex":"0x5",
   "blockHash":"0x78be965408ebcf607c79fe2acfebc2b463301fcc986ff8227c1b1a6459a16a7e",
   "logIndex":"0x26",
   "removed":false
}`

	var vLogOperatorAdded types.Log
	err := json.Unmarshal([]byte(rawOperatorAdded), &vLogOperatorAdded)
	require.NoError(t, err)
	contractAbi, err := abi.JSON(strings.NewReader(ContractABI()))
	require.NoError(t, err)
	require.NotNil(t, contractAbi)
	parsed, isEventBelongsToOperator, err := ParseOperatorAddedEvent(zap.L(), nil, vLogOperatorAdded.Data, contractAbi)
	require.NoError(t, err)
	require.NotNil(t, contractAbi)
	require.False(t, isEventBelongsToOperator)
	require.NotNil(t, parsed)
	require.Equal(t, "asd1123", parsed.Name)
}

func TestParseValidatorAddedEvent(t *testing.T) {
	rawValidatorAdded := `{
   "address":"0xfdff361ed2b094730fdd8fa9658b370ce6cd4b10",
   "topics":[
      "0x088097840a21a2c763dd9bd97cc2b0b27628bb6a42124a398260fac7f31ff571"
   ],
   "data":"0x0000000000000000000000004e409db090a71d14d32adbfbc0a22b1b06dde7de00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000d200000000000000000000000000000000000000000000000000000000000000f4000000000000000000000000000000000000000000000000000000000000000308095b9398e1a3a58bae632db4d9d981f10c69172911e4a4c04b4c9bfc64b13bd2eeb8f49e280db211186c3c7ca5f3233000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000092000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424d6b4e5152455256624846574e32357a4f4746444e575a4f4e33634b6255686955305a51525449325a56564355553971516c453354445a4c576c56735133464c4e32466f636b4e474e474a5561316c6164554a5762554a34626d737a596e453254586853556b354557564e4a556c5a48626770346257746f6257465a566b566c5a7a6c7263564a446157597a6447314f574670524d306c56576d7468625770316448644462335a546546425a4e57564c6347465354334244525841764e30354e54555234636d687a436b5a305a4777324f47493261564636546a6c7559303876595446346544526a6546423661564532656d78735a304a4b4d58413052306c6e566c526f576d6f7a654842314d6c42505457786b51574e764b3039566155594b55316378556e5a775a446857636d564d5a57685462477074616e566b536e466b595746424d314a34656b355964545a5853314d3165546b3352544e72596a6c61656b78714d484a4753554677656c5135616e4a544f51706b5432464e5432785a5a544652647a497a515756764e485248624468695a337059626d464a575374366146646e5446564b5a4468305a7a4e35626b4d355758644757545a6c59566845616d465452576f7a55555a6c436b4e335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642645464795a6a5644567a52345548464d4e444679654735504e58594b5333517a5a4870325454646d5645645a524641355530526b526e4e6a55574a59616e6868544670684d474e764b334e4f52305278536c5a5a6556465559334a745a30737a4d475a4c4f486c6a5246423655464a696151707654467033535578504e315a4b636c684365466448633073766547394354475646656c4a78556b4d78636c46505444597a59565a35546e466b57577334654856514e5774754b3367344e456c4b6132457851336c68436c4e7965476c455a6e4e5054475579527a63796430786a53336c71556b6c46646c42574d326476535555776257314e64586c6d62586c71516d354561454e7162564e5653315a4e625751724e484678536c63766379384b646c464365474e4a6345464a4d6c42704d3074345a6e52744e31467356575a334b324e5a63484a50596a6c4d5257357362305a6e5354684d543255725533466e52465251564535514f437474523064525a3156744d51707053554633626e5a756355394561446850525845764b3038325254525952464a4762315a7164334a56517a564b516d703161544a724d545a52563268454d45313663546847576e56725a5539756269744b4e45314e436e68335355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e4255555642646d3170576c465162464268546c42755445704e546e52584e32634b5133687663575659545646524d324e695457393353475a6c4e6e646e4f5752325a545649616e68494d3235554e7a6b7a64455a4c61444a776455557a5355557a524756775245317056576c305a6d4645644731425667706f616b6c7563577033526a5a70626b785054306c355332526859573030546e6442576a5a525369746a646e4a684c31646863325a76636d704b5357705464474652613078435a6d68754f4464485357513551586468436d383257555659556e4e684d6c4131566b6c4e5a56464554305273633352494f555135626d4a596444417753304a49646b39694d46424c61464a5555585255596b646f534752425446493161454a586545564b596a674b526e42305a54557a546b3179564774774d304e71556a4257625442705457464d64474e784f57704757546c61546e4a3352464a74656e6c6b5555744d576974304b7a52704d6e5a78627a4269654339525257314861776f76556a46316346684a536b78474e57783461573952516a4a72626b5a724e7a42464e58706c5632526e4c3164434b30784c5369744654336c77626d39714d314e68556e42704c33424a4f5645325632356951584a78436b46525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002644c5330744c5331435255644a54694253553045675546564354456c4449457446575330744c533074436b314a53554a4a616b464f516d64726357687261556335647a424351564646526b464254304e425554684254556c4a516b4e6e53304e42555556424d47566c626b685663533957565442724b324e325631464a5756674b6231423363336c566554467a6144464d616d5a6b546b687965573161563070355a6b30306445647564573431547a644561584a75546a644562467068626a526953314659544568324d69745959553173593341766141704a5447566a637a68364e5730724e56426d63454d72615749324d33517859325a6a4b33527351324d30516d353365444250596c427353326c50516c4130523142485546413462466c574e577458566b49344e474a78436b3551533352476331684b59584976556b354e556b7454524556324d57785954445a43576d745a64577872566c707853336c734d6d64476133467563445a6c5a303478643142584f476f335a30396a5657704c5a31494b5630526e4d316f355a5846515a3145335a6b3531543078554b33464e59336b345657317a4e7974436233683561336732543149344c334e4d626c4a34525552334e556c7265576c6e596c4a4d53305a705a6e466b65416f77627a426d556a4e334d3073796231463053453932553239485631464e64454d7765553934567a6845644564544b7a4a515445744d5930316e6347704f65445177534563765a6d70354d31566c566d56564f457051436b74525355524255554643436930744c5330745255354549464a545153425156554a4d53554d675330565a4c5330744c53304b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000003080cfc6d3338484432d20deb9ac95583ae507bd2a12a1df1a57e490800784d163e5d61d165fc811d88ed31a01bc7fb82f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003081f08f30cfd8a9abfd88ac7a9f7980e98e7a05a59b941988d72a519cf039e2c51398e6280e435b667b1e7cfca6643cef000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030b75818cb40c685043ff75a99ff25c5d92a18e77ee31ba463c2238d85e1c6f7c147f2c3a328a3042c5426664b8a951eea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030b819d24f5cfaf7aa4456ef929b82ef96766516a06bc30fadc5e405c7f3a4a8d2b685819ebfc103b9f59f99502dabe09300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001586c69776847497663534f556f6e3730327049356b4c6f6a6c44416769527954515a664b2f2b687377564c364b6d56644e635a627932466556466e4341773470666d47596a2b35424d53445555692f33436e516945537374503858722f64757737704c696b563555367347504855565a633374594a48307339522f46472b4d483847764f666c755574506b5637734264523862585a4f527865646a66547149634e49444d716543792b3165676d37575133356b6765554939565935367638446a51514d6649445967645564306c53596f494e6354766b30385a634451626e31304a65794734426b2f5937453654614e63775733723233726244322b444f41693555474668504f38712b43714d2f4259744d6b39516d49362f4a534e752b454f3157496971494b394b4c716d42525554526b49434e657a465553662f74787461654364504f4c434154786553347748512b445943306551773d3d000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001584b65515370506a3837554d724c2b53574748374467655a6b596a77487646354f6838506f415952677644456d7870426d38755179367547376f7961384a705647686357354d34366676564a6a4b435470522f653652512b545630453858387438683164496d6e4d5476774b726e434a5177705a533157715845336851457738653546465856354d5459624d3634464139714e652b7235382f7834716c683251354c54456f6837437a5938426246465455664f6d747a35597057365477544e52724d304e482f545971574b4c727171686d314337566332514256706e353930456c516134504e766c565955775645426e64414b53306874697339736b645043383578423836543431304d424b46317a71746c61786346616d6664516169727476754d506b714169396647304a3030556342504e466a4376443776736f4e486a7537436546564f6653725a353355786148716230764671413d3d000000000000000000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001586730526f3379444a67733666754b476e7036426d5a664f527851425877707a596e714857465a4d413273583339784b733372743469377353393143326b697a4d42466b6b4d6c394d6548476578674f6b4b546f707647413878416269432b4f4d584e4e65435835387847456a58773937344a715248524442316e7371364b685a6877564f4f6e52524a556f444b657064614c4d4f482b455368796a4739737558542b744b4b6833434e716f35696a5432594541796f3675597070346c63372f664d4b4c7237434b7531646e4f4f36462b586a76706155434e75364f6f35397a4d777974386e347169654f58366d78784b54764173697a4e5663476974546873796e4355544b376c493947576955714a5852644437467054457a564b514e652b42644c3532674c4672464873346453374c58784674526f417831523437734468526b706431535647386366597938724a564630427a74513d3d000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000158576e7075482f6a4e365675794b767055546a5972484e53597a746a68675a53436452566f58517836322f4a7a51674357496b776b626f6c504e316a396f53744b7557614b53462b7649722b356e465745646c424778734845584f3446732b6e6959704d536648486c617a744e4455362b5a5a70307a446142597a2b6d434359626a324755502f5855432b464c636a656834757661425461336d586c5239704770796d7679436b6e4e61397459666c4c39653931733558316d4f764a4d327732327342694463317951766b5367695847755262616c31644a51747143394d4567675a6e555a3764517a5058795559706444444d4867534a59654f4b614856657150542f506676377644626554574e367a30496a5a6f386d62503451304e36455a7764392b7963416c7042694b6f5542684e67394d6236444275397a435a676e6256644d64514a4c504f694f3342423230694d4f58556f673d3d0000000000000000",
   "blockNumber":"0x5aab39",
   "transactionHash":"0x44c139ec31a10f53561834a44b597edd1f38ca49233853133d5e5d583f19a1dd",
   "transactionIndex":"0x0",
   "blockHash":"0x24f497fcb229f4592e958cb3102eda7d31ef5ecbb47cb104719e3c316717a780",
   "logIndex":"0x2",
   "removed":false
}`

	var vLogValidatorAdded types.Log
	err := json.Unmarshal([]byte(rawValidatorAdded), &vLogValidatorAdded)
	require.NoError(t, err)
	contractAbi, err := abi.JSON(strings.NewReader(ContractABI()))
	require.NoError(t, err)
	require.NotNil(t, contractAbi)

	parsed, isEventBelongsToOperator, err := ParseValidatorAddedEvent(zap.L(), nil, vLogValidatorAdded.Data, contractAbi)
	require.NoError(t, err)
	require.NotNil(t, contractAbi)
	require.False(t, isEventBelongsToOperator)
	require.NotNil(t, parsed)
	require.Equal(t, "8095b9398e1a3a58bae632db4d9d981f10c69172911e4a4c04b4c9bfc64b13bd2eeb8f49e280db211186c3c7ca5f3233",
		hex.EncodeToString(parsed.PublicKey))
}
